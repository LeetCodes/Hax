<!DOCTYPE html>
<meta charset=utf-8>
<meta name=viewport content="width=device-width, initial-scale=1, maximum-scale=1">

<title>JSON-RPC Introspect</title>

<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.5.1/build/cssreset/cssreset-min.css">
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.5.1/build/cssbase/cssbase-min.css">
<link rel=stylesheet href=css/test.css>

<body>
<div id="header"></div>
<div id="menu"></div>
<div id="output"></div>

<script>window.DEBUG = true</script>
<script src="js/jquery.min.js"></script>
<script src="js/Q.js"></script>
<script src="js/json.js"></script>
<script src="js/jsonrpc.js"></script>

<script>

(function (window, $, undefined) {

	var parseURL = function (url, m) {
		var temp = document.createElement('a');
		temp.href = url || '/';
		var modifyObject = function (object, modifications) {
			if (!(modifications instanceof Array)) modifications = [modifications];
			$.each(modifications, function (i, modification) {
				if (modification instanceof Function) modification.apply(object);
				else if (modification instanceof Array) object = modifyObject(object, modification);
				else $.extend(object, modification);
			});
			return object;
		};
		if (m) temp = modifyObject(temp, m);
		return temp.href;
	},
	getData = function (server, callback) {
		var q = Q(), data, permission;
		q.add(function (c) {
			server.sendMessage('JSONRPC.Introspect', { 'getmetadata': true }, function (d) {
				data = d.result;
				c();
			});
		});
		q.add(function (c) {
			server.sendMessage('JSONRPC.Permission', function (d) {
				data.permissions = d.result;
				c();
			});
		});
		q.add(function (c) { //traverse types and expand references
			var expandType = function (type) {
				if (type['extends'] && !(type['extends'] instanceof Array)) type['extends'] = [type['extends']];
				if (type['extends'] instanceof Array) {
					$.each(type['extends'], function (key, value) {
						var t = expandType(data.types[value]);
						if (t.properties) {
							if (!type.properties) type.properties = {};
							$.extend(type.properties, t.properties);
						}
						if (data.types[value].items) {
							if (!type.items) type.items = {};
							$.extend(type.items, t.items);
						}
					});
					delete type['extends'];
				}
				return type;
			};
			$.each(data.types, function (t, type) {
				expandType(type);
			});
			c();
		});
		q.add(function (c) { //traverse methods/notifications and expand references
			var R = function (d) {
				if (d['$ref']) {
					$.extend(d, data.types[d['$ref']]);
					delete d['$ref'];
				}
				$.each(d, function (key, value) {
					if (value instanceof Array || value instanceof Object) R(value);
				});
			};
			R(data.methods);
			R(data.notifications);
			c();
		});
		q.add(function (c) { //create syntax and results
			var tabs = function (n) {
				return n ? "\n"+Array(n + 1).join("\t") : "\n";
			},
			print = function (p, depth) {
				var out = [], string = '', type = p.type, comments = [], types = [],
				printProperties = function (items) {
					if (items) $.each(items, function (key, value) {
						out.push(key+': '+print(value, depth+1));
					});
					return out.join(','+tabs(depth+1));
				};
				if (!depth) depth = 0;
				//guess type
				if (p.properties) type = 'object';
				if (p.items) type = 'array';
				if (p.enums) type = 'string';
				
				if (p.id) comments.push(p.id);
				if (p.required) comments.push('required');
				if (p.enums instanceof Array) comments.push(type+" ('"+p.enums.join("', '")+"')");
				else if (type && type !== 'object' && type !== 'array') comments.push(type);
				//if (p.minLength !== undefined) comments.push('minimum length: '+p.minLength);
				if (p.minimum !== undefined) comments.push('minimum: '+p.minimum);
				if (p.maximum !== undefined) comments.push('maximum: '+p.maximum);
				if (p.description) comments.push(p.description);
				
				if (comments.length) comments = ' /* '+comments.join(', ')+' */';
				else comments = '';
				
				if (type === 'object') types.push('{'+comments+tabs(depth+1)+printProperties(p.properties)+tabs(depth)+'}');
				if (type === 'array') types.push('['+comments+tabs(depth+1)+print(p.items, depth+1)+tabs(depth)+']');
				if (type instanceof Array) $.each(type, function (key, value) {
					types.push(print(value, depth));
				});
				if (types.length) return types.join(' or ');
				
				string = p['default'] === undefined ? 'undefined' :
					p['default'] === null ? 'null' :
					typeof p['default'] === 'string' ? "'"+p['default']+"'" :
					p['default'];
				string += comments;
					
				return string;
			},
			printItem = function (itemName, item, method) {
				var syntaxArray = [];
				if (item.params) {
					$.each(item.params, function (paramName, param) {
						syntaxArray.push( param['name']+': '+print(param, 2) );
					});
					item.syntax = method+"( '"+itemName+"',"+tabs(1)+'{'+tabs(2)+syntaxArray.join(','+tabs(2))+tabs(1)+'},'+tabs(1)+'function (data) { console.dir(data); }'+tabs(0)+");";
				}
				if (item.params) delete item.params;
				
				if (item.returns) item.result = print(item.returns);
				if (item.returns) delete item.returns;
				
				if (item.type) delete item.type;
			};
			$.each(data.notifications, function (itemName, item) { printItem(itemName, item, 'server.onNotification') });
			$.each(data.methods, function (itemName, item) { printItem(itemName, item, 'server.sendMessage') });
			c();
		});
		q.onfinish(function () {
			callback(data);
		});
		q.start();
	},
	order = [
		'name',
		'description',
		'type',
		'id',
		'permission',
		'syntax',
		'result'
	],
	renderItem = function (itemName, item, out) {
		//if (item === null) return;
		//if (itemName === 'id') return;
		//if (itemName === 'type') return;
		return $('<li></li>').
		  attr('data-title',itemName).
		  append('<div class="title">'+itemName+'</div>').
		  append(renderTree(item)).
		  appendTo(out);
	},
	renderTree = function (d) {
		var $out = $('<ul></ul>');
		if (!(d instanceof Array || d instanceof Object)) {
			$out = $('<div data-type="'+typeof d+'"></div>').text(d);
		}
		else {
			$.each(order, function (i, name) {
				$.each(d, function (itemName, item) {
					if (itemName === name) renderItem(itemName, item, $out);
				});
			});
			$.each(d, function (itemName, item) {
				var visible = true;
				$.each(order, function (i, name) {
					if (itemName === name) visible = false;
				});
				if (visible) renderItem(itemName, item, $out);
			});
		}
		if (d instanceof Array) $out.addClass('array');
		return $out;
	},
	renderData = function (d) {
		console.dir(d);
		$('#output').
		  html('').
		  append(renderTree(d));
		window.scrollTo(0,0);
	},
	renderHeader = function (d) {
		var h = {};
		h[d.description] = {
			'Version': d.version
		}
		$('#header').
		  html('').
		  append(renderTree(h));
	},
	renderMenuTree = function (d, depth) {
		var $out = $('<ul></ul>');
		if (!depth) depth = 0;
		if (d instanceof Object) $.each(d, function (i, item) {
			var $item = $('<li></li>');
			$item.attr('data-title',i);
			if (depth < 2) {
				$item.append('<div class="title">'+i+'</div>');
				$item.append(renderMenuTree(item,depth+1));
			}
			else {
				$item.append('<div>'+i+'</div>');
				$item.click(function () {
				  	renderData(item);
				});
			}
			$item.appendTo($out);
		});
		return $out;
	},
	renderMenu = function (d) {
		var menus = {};
		$.each({
			'Methods': d.methods,
			'Notifications': d.notifications
		}, function (name, items) {
			if (!menus[name]) menus[name] = {};
			$.each(items, function (itemName, item) {
				var s = itemName.split('.');
				if (!menus[name][s[0]]) menus[name][s[0]] = {};
				menus[name][s[0]][s[1]] = {};
				menus[name][s[0]][s[1]][itemName] = item;
			});
		});
		$('#menu').
		  html('').
		  append(renderMenuTree(menus));
	},
	connect = function (address) {
		var URL = parseURL('/', { 'pathname': 'jsonrpc'/*, 'protocol': 'ws', 'port': 9090*/ });
		window.server = JSONRPC(URL);
		getData(window.server, function (d) {
			renderHeader(d);
			renderMenu(d);
		});
	};

	$(function () { //when the page has finished loading
		connect(); //try to connect
	});

})(window, jQuery, undefined);

</script>
