<!DOCTYPE html>
<meta charset=utf-8>
<meta name=viewport content="width=device-width, initial-scale=1, maximum-scale=1">

<title>JSON-RPC Introspect</title>

<link rel=stylesheet type=text/css href="http://yui.yahooapis.com/3.5.1/build/cssreset/cssreset-min.css">
<link rel=stylesheet type=text/css href="http://yui.yahooapis.com/3.5.1/build/cssbase/cssbase-min.css">
<style>
	ul, ol, li {
		list-style: none;
		margin-top:0;
	}
	[data-type] {
		white-space: pre;
		margin-left:2em;
	}
	[data-title="Description"] .title {
		display:none;
	}
</style>

<body>
<div id=header></div>
<div id=menu></div>
<div id=output></div>
<div style="clear:both;"></div>

<script>window.DEBUG = true</script>
<script src=jquery.js></script>
<script src=Q.js></script>
<script src=parseURL.js></script>
<script src=jsonrpc.js></script>
<script>
(function (window, $, undefined) {
	"use strict";
	
	var TAB_WIDTH = 4,
	NAMESPACES = {
		'JSONRPC': { 'Description': 'A variety of standard JSONRPC calls' },
		'Player': { 'Description': 'Manages all available players' },
		'Playlist': { 'Description': 'Playlist modification' },
		'Files': { 'Description': 'Shares information' },
		'AudioLibrary': { 'Description': 'Audio Library information' },
		'VideoLibrary': { 'Description': 'Video Library information' },
		'Input': { 'Description': 'Allows limited navigation within XBMC' },
		'Application': { 'Description': 'Application information and control' },
		'System': { 'Description': 'System controls and information' },
		'XBMC': { 'Description': 'Dumping ground for very XBMC specific operations' }
	},
	COMMENTS = {
		'type': function () {
			var str = '';
			if (this.type === undefined) return;
			if (this.type === 'object') return; //objects have curly braces so type doesn't have to be specified here
			if (typeof this.type === 'string') str += this.type;
			if (this['enum'] instanceof Array) {
				str += " ('"+this['enum'].join("', '")+"')"
			}
			return str;
		},
		'required': { 'true': 'required' },
		'id': 'id',
		'uniqueItems': { 'true': 'all items must be unique' },
		'additionalProperties': { 'false': 'no additional properties allowed' },
		'disallow': 'not type',
		'format': 'format',
		'pattern': 'match',
		'divisibleBy': 'divisible by',
		'minimum': 'minimum',
		'maximum': 'maximum',
		'minItems': 'minimum items',
		'maxItems': 'maximum items',
		'minLength': 'minimum length',
		'maxLength': 'maximum length',
		'exclusiveMinimum': 'exclusive minimum',
		'exclusiveMaximum': 'exclusive maximum',
		'dependencies': 'dependencies',
		'description': '',
		//'patternProperties': 'match',
	},
	getData = function (server, callback) {
		var q = Q(), data = {}, output = NAMESPACES;
		q.add(function (c) {
			server.sendMessage('JSONRPC.Introspect', { 'getmetadata': true }, function (d) {
				console.dir(d)
				$.extend(data, d.result);
				c();
			});
		});
		q.add(function (c) { //traverse types and expand references
			var expandType = function (type) {
				if (type['extends'] && !(type['extends'] instanceof Array)) type['extends'] = [type['extends']];
				if (type['extends'] instanceof Array) {
					$.each(type['extends'], function (key, value) {
						var t = expandType(data.types[value]);
						if (t.properties) {
							if (!type.properties) type.properties = {};
							$.extend(type.properties, t.properties);
						}
						if (data.types[value].items) {
							if (!type.items) type.items = {};
							$.extend(type.items, t.items);
						}
					});
					delete type['extends'];
				}
				return type;
			};
			$.each(data.types, function (t, type) {
				expandType(type);
			});
			c();
		});
		q.add(function (c) { //traverse methods/notifications and expand references
			var R = function (d) {
				if (d['$ref']) {
					$.extend(d, data.types[d['$ref']]);
					delete d['$ref'];
				}
				$.each(d, function (key, value) {
					if (value instanceof Array || value instanceof Object) R(value);
				});
			};
			R(data.methods);
			R(data.notifications);
			c();
		});
		q.add(function (c) { //create syntax and results
			var tabs = function (n) {
				return n ? "\n"+Array(n*TAB_WIDTH+1).join(" ") : "\n";
			},
			print = function (p, depth) {
				var out = [], string = '', type = p.type, comments = [], types = [], params = [],
				printProperties = function (items) {
					if (items) $.each(items, function (key, value) {
						out.push("'"+key+"': "+print(value, depth+1));
					});
					return out.join(', '+tabs(depth+1));
				};
				if (!depth) depth = 0;
				//guess type
				if (p.properties) type = 'object';
				if (p.items) type = 'array';
				if (p.enums) type = 'string';
				if (p.params) type = 'message';
				
				$.each(COMMENTS, function (name, description) {
					var property = p[name],
					descriptionIsString = typeof description === 'string',
					descriptionIsObject = description instanceof Object,
					propertyIsString = typeof property === 'string',
					propertyIsArray = property instanceof Array,
					propertyIsBoolean = property instanceof Boolean,
					propertyIsObject = property instanceof Object,
					propertyIsNumber = !isNaN(property-0);
						
					if (description instanceof Function) {
						var o = description.call(p);
						if (o !== undefined) comments.push(o);
						return;
					}
					
					if (property === undefined) return;
					
					if (descriptionIsString && description !== '') description += ': ';
					if (propertyIsString || propertyIsNumber) {
						if (descriptionIsString) comments.push(description+property);
						else if (descriptionIsObject && description[property] !== undefined) comments.push(description[property]);
					}
					else if (descriptionIsString && propertyIsArray) comments.push(description+property.join(', '));
					else if (propertyIsBoolean) {
						if (descriptionIsString && property) comments.push(description);
						else if (descriptionIsObject) {
							if (property && typeof description.true === 'string') comments.push(description.true);
							if (!property && typeof description.false === 'string') comments.push(description.false);
						}
					}
					else if (descriptionIsString && propertyIsObject) {
						var properties = [];
						$.each(property, function (key, value) {
							properties.push(key+': '+value);
						});
						comments.push(description+properties.join(', '));
					}
				});
				if (comments.length) comments = ' /* '+comments.join(', ')+' */';
				else comments = '';
				
				if (type === 'object') types.push('{'+comments+tabs(depth+1)+printProperties(p.properties)+tabs(depth)+'}');
				if (type === 'array') types.push('['+comments+tabs(depth+1)+print(p.items, depth+1)+tabs(depth)+']');
				if (type === 'message') {
					console.dir(p.params)
					$.each(p.params, function (i, param) {
						params.push(tabs(depth+1)+"'"+param['name']+"': "+print(param, depth+1));
					});
					types.push('{'+comments+params.join(', ')+tabs(depth)+'}');
				}
				if (type instanceof Array) $.each(type, function (key, value) {
					types.push(print(value, depth));
				});
				if (types.length) return types.join(' or ');
				
				string = p['default'] === undefined ? 'undefined' :
					p['default'] === null ? 'null' :
					typeof p['default'] === 'string' ? "'"+p['default']+"'" :
					p['default'];
				string += comments;
					
				return string;
			},
			syntaxHighlight = function (str) {
				return '<syntaxhighlight lang="javascript">'+tabs(0)+str+tabs(0)+'</syntaxhighlight>'
			},
			printMethod = function (itemName, item, method) {
				var out = {};
				out.Syntax = {
					'properties': {
						'jsonrpc': { 'default': '2.0' },
						'method': { 'default': itemName },
						'id': { 'type': 'integer', 'required': true }
					}
				};
				if (item.params instanceof Array && item.params.length) out.Syntax.properties.params = { 'params': item.params };
				if (item.returns) out.Returns = {
					'properties': {
						'jsonrpc': { 'default': '2.0' },
						'method': { 'default': itemName },
						'id': { 'type': 'integer', 'required': true },
						'result': item.returns
					}
				};
				out.Syntax = syntaxHighlight(print(out.Syntax));
				out.Returns = syntaxHighlight(print(out.Returns));
				out.Permissions = item.permission || 'none';
				out.Description = item.description || '';
				return out;
			},
			printNotification = function (itemName, item, method) {
				var out = {};
				if (item.params) {
					out.Returns = {
						'properties': {
							'jsonrpc': { 'default': '2.0' },
							'method': { 'default': itemName }
						}
					};
				}
				if (item.params instanceof Array && item.params.length) out.Returns.properties.params = { 'params': item.params };
				out.Returns = syntaxHighlight(print(out.Returns));
				out.Description = item.description || '';
				return out;
			},
			printType = function (itemName, item) {
			};
			$.each(splitItems(data.notifications), function (namespace, notifications) {
				if (output[namespace] === undefined) output[namespace] = {};
				if (output[namespace].Notifications === undefined) output[namespace].Notifications = {};
				$.each(notifications, function (itemName, item) {
					output[namespace].Notifications[itemName] = printNotification(itemName, item, 'server.sendMessage');
				});
			});
			$.each(splitItems(data.methods), function (namespace, methods) {
				if (output[namespace] === undefined) output[namespace] = {};
				if (output[namespace].Methods === undefined) output[namespace].Methods = {};
				$.each(methods, function (itemName, item) {
					output[namespace].Methods[itemName] = printMethod(itemName, item, 'server.sendMessage');
				});
			});
			c();
		});
		q.onfinish(function () {
			callback(output);
		});
		q.start();
	},
	order = [
		'Description',
		'Permissions',
		'Syntax',
		'Result'
	],
	splitItems = function (items) {
		var out = {};
		$.each(items, function (itemName, item) {
			var s = itemName.split('.');
			if (!out[s[0]]) out[s[0]] = {};
			out[s[0]][itemName] = item;
			if (item instanceof Object && item.id === undefined) item.id = itemName;
		});
		return out;
	},
	renderItem = function (itemName, item, depth, out) {
		//if (item === null) return;
		//if (itemName === 'id') return;
		//if (itemName === 'type') return;
		return $('<li></li>').
		  attr('data-title',itemName).
		  append('<div class="title">'+wikiHeader(itemName,depth)+'</div>').
		  append(renderTree(item, depth+1)).
		  appendTo(out);
	},
	wikiHeader = function (text, n) {
		//if (n >2) return "&lt;br&gt;'''"+text+"'''&lt;br&gt;";
		return Array(n+2).join('=')+text+Array(n+2).join('=');
	},
	renderTree = function (d, depth) {
		var $out = $('<ul></ul>');
		if (!depth) depth = 0;
		if (!(d instanceof Array || d instanceof Object)) {
			$out = $('<div data-type="'+typeof d+'"></div>').text(d);
		}
		else {
			$.each(order, function (i, name) {
				$.each(d, function (itemName, item) {
					if (itemName === name) renderItem(itemName, item, depth, $out);
				});
			});
			$.each(d, function (itemName, item) {
				var visible = true;
				$.each(order, function (i, name) {
					if (itemName === name) visible = false;
				});
				if (visible) renderItem(itemName, item, depth, $out);
			});
		}
		if (d instanceof Array) $out.addClass('array');
		return $out;
	},
	renderData = function (d) {
		$('#output').
		  html('').
		  append(renderTree(d));
		window.scrollTo(0,0);
	},
	connect = function (address) {
		var URL = parseURL('/', { 'pathname': 'jsonrpc'/*, 'protocol': 'ws', 'port': 9090*/ });
		window.server = JSONRPC(URL, true);
		getData(window.server, function (d) {
			renderData(d);
		});
	};

	$(function () { //when the page has finished loading
		connect(); //try to connect
	});

})(window, jQuery, undefined);

</script>
