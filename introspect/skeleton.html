<!DOCTYPE html>
<meta charset=utf-8>
<meta name=viewport content="width=device-width, initial-scale=1, maximum-scale=1">

<title>JSON-RPC Test</title>

<link rel=stylesheet type=text/css href="http://yui.yahooapis.com/3.5.1/build/cssreset/cssreset-min.css">
<link rel=stylesheet type=text/css href="http://yui.yahooapis.com/3.5.1/build/cssbase/cssbase-min.css">
<link rel=stylesheet href=style.css>
<style>
	[data-type="string"] {
		white-space:pre;
	}
</style>

<body>
<div id=header></div>
<div id=menu></div>
<div id=output></div>
<div style="clear:both;"></div>

<script>window.DEBUG = true</script>
<script src=jquery.js></script>
<script src=Q.js></script>
<script src=parseURL.js></script>
<script src=jsonrpc.js></script>
<script>

(function (window, $, undefined) {
	"use strict";
	
	var TAB_WIDTH = 4,
	getData = function (server, callback) {
		var q = Q(), data = {};
		q.add(function (c) {
			server.sendMessage('JSONRPC.Introspect', { 'getmetadata': true }, function (d) {
				console.dir(d)
				$.extend(data, d.result);
				c();
			});
		});
		q.add(function (c) { //traverse types and expand references
			var expandType = function (type) {
				if (type['extends'] && !(type['extends'] instanceof Array)) type['extends'] = [type['extends']];
				if (type['extends'] instanceof Array) {
					$.each(type['extends'], function (key, value) {
						var t = expandType(data.types[value]);
						if (t.properties) {
							if (!type.properties) type.properties = {};
							$.extend(type.properties, t.properties);
						}
						if (data.types[value].items) {
							if (!type.items) type.items = {};
							$.extend(type.items, t.items);
						}
					});
					delete type['extends'];
				}
				return type;
			};
			$.each(data.types, function (t, type) {
				expandType(type);
			});
			c();
		});
		q.add(function (c) { //traverse methods/notifications and expand references
			var R = function (d) {
				if (d['$ref']) {
					$.extend(d, data.types[d['$ref']]);
					delete d['$ref'];
				}
				$.each(d, function (key, value) {
					if (value instanceof Array || value instanceof Object) R(value);
				});
			};
			R(data.methods);
			R(data.notifications);
			c();
		});
		q.add(function (c) { //create syntax and results
			var tabs = function (n) {
				return n ? "\n"+Array(n*TAB_WIDTH+1).join(" ") : "\n";
			},
			print = function (p, depth) {
				var out = [], string = '', type = p.type, comments = [], types = [],
				printProperties = function (items) {
					if (items) $.each(items, function (key, value) {
						out.push(key+': '+print(value, depth+1));
					});
					return out.join(', '+tabs(depth+1));
				};
				if (!depth) depth = 0;
				//guess type
				if (p.properties) type = 'object';
				if (p.items) type = 'array';
				if (p.enums) type = 'string';
				
				if (p.id) comments.push(p.id);
				if (p.required) comments.push('required');
				if (p.enums instanceof Array) comments.push('type: '+type+" ('"+p.enums.join("', '")+"')");
				else if (type && type !== 'object' && type !== 'array') comments.push('type: '+type);
				//if (p.minLength !== undefined) comments.push('minimum length: '+p.minLength);
				if (p.minimum !== undefined) comments.push('minimum: '+p.minimum);
				if (p.maximum !== undefined) comments.push('maximum: '+p.maximum);
				if (p.description) comments.push(p.description);
				
				if (comments.length) comments = ' /* '+comments.join(', ')+' */';
				else comments = '';
				
				if (type === 'object') types.push('{'+comments+tabs(depth+1)+printProperties(p.properties)+tabs(depth)+'}');
				if (type === 'array') types.push('['+comments+tabs(depth+1)+print(p.items, depth+1)+tabs(depth)+']');
				if (type instanceof Array) $.each(type, function (key, value) {
					types.push(print(value, depth));
				});
				if (types.length) return types.join(' || ');
				
				string = p['default'] === undefined ? 'undefined' :
					p['default'] === null ? 'null' :
					typeof p['default'] === 'string' ? "'"+p['default']+"'" :
					p['default'];
				//if (p.enums instanceof Array) string += ", '"+p.enums.join("', '")+"'";
				string += comments;
					
				return string;
			},
			printMethod = function (itemName, item, method) {
				var syntaxArray = [], syntax = '';
				if (item.params) {
					$.each(item.params, function (paramName, param) {
						syntaxArray.push( param['name']+': '+print(param, 5) );
					});
					syntax += "'"+itemName+"': function (callback, params) {";
					if (item.description) syntax += "  /* "+item.id+': '+item.description+" */";
					syntax += tabs(3)+method+"( '"+itemName+"',";
					if (syntaxArray.length) {
						syntax += tabs(4)+'$.extend('+'{';
						syntax += tabs(5)+syntaxArray.join(", "+tabs(5));
						syntax += tabs(4)+'}, config),';
					}
					syntax += tabs(4)+'callback';
					syntax += tabs(3)+");";
					syntax += tabs(2)+'}';
				}
				return syntax;
			},
			printNotification = function (itemName, item, method) {
				var syntaxArray = [], syntax = '';
				syntax += method+"( '"+itemName+"',"+tabs(1)+"function (data) { console.log('"+itemName+"', data); }"+tabs(0)+");";
				return syntax;
			},
			skeleton = {};
			//$.each(data.notifications, function (itemName, item) { skeleton.push(printNotification(itemName, item, 'server.onNotification')) });
			console.dir(splitItems(data.methods));
			$.each(splitItems(data.methods), function (namespace, methods) {
				if (skeleton[namespace] === undefined) skeleton[namespace] = [];
				$.each(methods, function (methodName, method) {
//					console.log(methodName, method)
					skeleton[namespace].push(printMethod(methodName, method, 'server.sendMessage'));
				});
			});
			delete data.notifications;
			delete data.methods;
			delete data.types;
			data.skeleton = 'rpc = {';
			$.each(skeleton, function (namespace, methods) {
				data.skeleton += tabs(1)+"'"+namespace+"': {";
				data.skeleton += tabs(2)+methods.join(','+tabs(2));
				data.skeleton += tabs(1)+'},';
			});
			data.skeleton += tabs(0)+'}';
			c();
		});
		q.onfinish(function () {
			callback(data);
		});
		q.start();
	},
	order = [
		'name',
		'description',
		'type',
		'id',
		'permission',
		'syntax',
		'result'
	],
	renderItem = function (itemName, item, out) {
		//if (item === null) return;
		//if (itemName === 'id') return;
		//if (itemName === 'type') return;
		return $('<li></li>').
		  attr('data-title',itemName).
		  append('<div class="title">'+itemName+'</div>').
		  append(renderTree(item)).
		  appendTo(out);
	},
	renderTree = function (d) {
		var $out = $('<ul></ul>');
		if (!(d instanceof Array || d instanceof Object)) {
			$out = $('<div data-type="'+typeof d+'"></div>').text(d);
		}
		else {
			$.each(order, function (i, name) {
				$.each(d, function (itemName, item) {
					if (itemName === name) renderItem(itemName, item, $out);
				});
			});
			$.each(d, function (itemName, item) {
				var visible = true;
				$.each(order, function (i, name) {
					if (itemName === name) visible = false;
				});
				if (visible) renderItem(itemName, item, $out);
			});
		}
		if (d instanceof Array) $out.addClass('array');
		return $out;
	},
	splitItems = function (items) {
		var out = {};
		$.each(items, function (itemName, item) {
			var s = itemName.split('.');
			if (!out[s[0]]) out[s[0]] = {};
			out[s[0]][s[1]] = item;
			if (item instanceof Object && item.id === undefined) item.id = itemName;
		});
		return out;
	},
	renderData = function (d) {
		$('#output').
		  html('').
		  append(renderTree(d));
		window.scrollTo(0,0);
	},
	connect = function (address) {
		var URL = parseURL('/', { 'pathname': 'jsonrpc'/*, 'protocol': 'ws', 'port': 9090*/ });
		window.server = JSONRPC(URL, true);
		getData(window.server, function (d) {
			renderData(d);
		});
	};

	$(function () { //when the page has finished loading
		connect(); //try to connect
	});

})(window, jQuery, undefined);


</script>
